name: Deploy Backend API to Azure Container Apps

on:
  push:
    branches:
      - main # ðŸ›‘ REMPLACEZ PAR VOTRE BRANCHE CIBLE SI NÃ‰CESSAIRE (ex: master)
    paths:
      - 'backend/**' # ðŸ›‘ AJUSTEZ CE CHEMIN si votre code backend est dans un sous-dossier

env:
  AZURE_CONTAINER_REGISTRY: iotserverlessacr # Le nom que Terraform a crÃ©Ã©
  CONTAINER_APP_NAME: iot-serverless-api
  RESOURCE_GROUP: iot-serverless-rg
  IMAGE_NAME: api-backend # Le nom de l'image que l'ACA attend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        # ðŸ›‘ VOUS DEVEZ CRÃ‰ER CE SECRET DANS GITHUB
        creds: ${{ secrets.AZURE_CREDENTIALS }} 

    - name: Build and push container image to ACR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }} # ðŸ›‘ VOUS DEVEZ CRÃ‰ER CE SECRET
        password: ${{ secrets.ACR_PASSWORD }} # ðŸ›‘ VOUS DEVEZ CRÃ‰ER CE SECRET

    - name: Build and push image
      id: build-image
      run: |
        docker build -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} .
        docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: Update Container App Revision
      uses: azure/container-apps-deploy-action@v1
      with:
        acrName: ${{ env.AZURE_CONTAINER_REGISTRY }}
        appName: ${{ env.CONTAINER_APP_NAME }}
        resourceGroup: ${{ env.RESOURCE_GROUP }}
        imageToDeploy: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        # Laissez la rÃ©vision Ã  "latest" pour le moment, car ACA gÃ¨re dÃ©jÃ  la rÃ©vision
